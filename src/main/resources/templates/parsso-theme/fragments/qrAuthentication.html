<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

    <title>loginProviders Fragment</title>
    <link href="../../static/css/cas.css" rel="stylesheet" th:remove="tag"/>
</head>
<body>
<main role="main">
    <div th:fragment="qrAuthentication" th:remove="tag">

        <script type="text/javascript" th:src="@{#{webjars.socket.js}}"></script>
        <script type="text/javascript" th:src="@{#{webjars.stomp.js}}"></script>

        <p class="serviceqr-login">جهت ورود، کد QR زیر را با استفاده از نرم افزار تلفن همراه پارسو اسکن کنید. جهت نصب و فعالسازی نرم افزار می بایست به بخش پروفایل کاربری در پارسو مراجعه کنید.</p>
        <img class="qr-img" th:src="@{'data:image/jpeg;base64,' + ${qrCode}}"/>

        <form method="post" id="qrform">
            <input id="token" name="token" type="hidden" />
            <input id="deviceId" name="deviceId" type="hidden" />
            <input type="hidden" name="execution" th:value="${flowExecutionKey}"/>
            <input type="hidden" name="_eventId" value="validate"/>
        </form>

        <script th:inline="javascript">
            /*<![CDATA[*/
            var endpoint = /*[[@{/qr-websocket}]]*/  ;
            var topic = /*[[${qrChannel}]]*/  ;
            var prefix = /*[[${qrPrefix}]]*/  ;

            var stompClient = null;
            $(function () {
                var socket = new SockJS(endpoint);
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function (frame) {
                    stompClient.subscribe(prefix + '/' + topic + '/verify', function (result) {
                        console.log(result.body);
                        let body = JSON.parse(result.body);
                        if (body.error) {
                            $("#qrerror").show();
                        } else if (body.success) {
                            stompClient.disconnect();
                            $("#qrerror").hide();
                            $("#qrform #token").val(body.token);
                            $("#qrform #deviceId").val(body.deviceId);
                            $("#qrform").submit();
                        }
                    });
                });
            });

            /*]]>*/
        </script>

        <form method="post" id="submitForm" th:action="@{/login}">
            <input type="hidden" id="eventId" name="_eventId" value="submit"/>
            <input type="hidden" name="execution" th:value="${flowExecutionKey}"/>
        </form>

    </div>
</main>
</body>
</html>

